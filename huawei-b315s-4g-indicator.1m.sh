#!/bin/bash

# <xbar.title>4G Indicator</xbar.title>
# <xbar.version>v0.1</xbar.version>
# <xbar.author>Tiaan Willemse</xbar.author>
# <xbar.author.github>tiaanwillemse</xbar.author.github>
# <xbar.desc>Checks the status of your 4G connection</xbar.desc>
# <xbar.dependencies>bash,curl</xbar.dependencies>
# Icon Credit https://www.iconfinder.com/icons/2639907/cellular_network_icon

sessionstring=$(curl --silent --output /dev/null --cookie-jar - 'http://192.168.8.1/html/home.html' \
  -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9' \
  -H 'Accept-Language: en-US,en;q=0.9,af;q=0.8' \
  -H 'Cache-Control: max-age=0' \
  -H 'Connection: keep-alive' \
  -H 'DNT: 1' \
  -H 'Referer: http://192.168.8.1/html/home.html' \
  -H 'Upgrade-Insecure-Requests: 1' \
  -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36' \
  --compressed \
  --insecure | grep HttpOnly)

sessionid=$(echo "$sessionstring" | sed 's/.*SessionID//')
sessionid=`echo $sessionid | sed 's/ *$//g'`

response=$(curl 'http://192.168.8.1/api/monitoring/status' \
  -H 'Accept: */*' \
  -H 'Accept-Language: en-US,en;q=0.9,af;q=0.8' \
  -H 'Connection: keep-alive' \
  -H "Cookie: SessionID=$sessionid" \
  -H 'DNT: 1' \
  -H 'Referer: http://192.168.8.1/html/home.html' \
  -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36' \
  -H 'X-Requested-With: XMLHttpRequest' \
  --compressed \
  --insecure)

signalvalue=$(sed -ne '/SignalIcon/{s/.*<SignalIcon>\(.*\)<\/SignalIcon>.*/\1/p;q;}' <<< "$response")
signalstrength="iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAAAMpJREFUWAntkrEOwiAQQEvZpXtjQsLk4i/4V/6D/+LkD+lOIgkDjRGhR3NNbMIIOHgsB1fCu3vXrqNFBsgAGSADZIAMkAEy8O8GeEYAg1wun7laPpXgTdd3pwkelVL7YRhO4zg+tNYfyFUtqsd2Fzjs+xDClXN+c86d8dt6B49lw+ZxKeUOnj/EGBPliKjlgPviYVOA9/4FhAkMJJBBWtURbP4Ba+1bCHEHAxNj7GKMeUIR63iwnrahaveplRxgtZJmH9r2S7QfGJgBiD8qcFRGDWoAAAAASUVORK5CYII="

if [ -z "$signalvalue" ] || [ "$signalvalue" == 0 ]; then
    signalstrength="iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAAANtJREFUWAntUkEOwiAQhFZ7hif0E1688BM/5SP0Pz6kJ00wgDtYPNSNF6ExcTehtMN2Z5hdpSTEAXFAHBAHxAFxQBz4YQc60qZpYV89QLxK9AwLbpzGcdxZa8/GmOs0TRfCMs7kfwVtmL9BFGkdhmHYe++RcpoxOJMA1Aquv4UghhCU1jorqEW4rMMJeOUQuUopNZ2HTwI6IocYCGgmghNQyG59n2f0TgKgBHhpD73WCW4IA0rT7Y80gNsYIwYQ0UTAs/T7s7hQTpbfBW+6a+ccHOLa1JRYiv+XAw9WHix1la5d0AAAAABJRU5ErkJggg=="
fi

if [ "$signalvalue" == 1 ]; then
    signalstrength="iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAAANtJREFUWAntUkEOwiAQhFZ7hif0E1688BM/5SP0Pz6kJ00wgDtYPNSNF6ExcTehtMN2Z5hdpSTEAXFAHBAHxAFxQBz4YQc60qZpYV89QLxK9AwLbpzGcdxZa8/GmOs0TRfCMs7kfwVtmL9BFGkdhmHYe++RcpoxOJMA1Aquv4UghhCU1jorqEW4rMMJeOUQuUopNZ2HTwI6IocYCGgmghNQyG59n2f0TgKgBHhpD73WCW4IA0rT7Y80gNsYIwYQ0UTAs/T7s7hQTpbfBW+6a+ccHOLa1JRYiv+XAw9WHix1la5d0AAAAABJRU5ErkJggg=="
fi

if [ "$signalvalue" == 2 ]; then
    signalstrength="iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAAATBJREFUWAntU8ENwjAMJCmtOkY7BQ8+fSMhvryYgw9TwBAMwgjswQ+UojbYll1FVYpKKQKkRALHF9vnXNzJJKygQFAgKBAUCAr8oQLqF3r+XhNZlqVjKqB7FqM4IN8qpS5gV5wX9czvDHvWAJ6h1GhrrrCM4ziFJhbsv22mHRWQWEitxGitTV0TbAR71/oUQMyCzLM8z09g10yirbVweZo/X96gXnwKkORAtEmSZF6WJRY+wg+vPvr0+24iktdVVSH5Hf8+tXwNNFwsd+M7G2nSgYZtnzWAb45V3RjlwYYxc5ZbXArJO9+iiD5zGgI+vDN2ZV9iJfdl6xtCeni46cEYg+c4gLSAfAfYGT7HPUMUy/tRTftm6PuwUUnbxVRRFKiA+0yasXYz7dzgBwV6K/AAVHM44Hju/SwAAAAASUVORK5CYII="
fi

if [ "$signalvalue" == 3 ]; then
    signalstrength="iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAAAc9JREFUWAntVbFOwzAQjRNaVaqEWjF2aTuxwMrAQGckJEYmvoPvgJUPYOYLOvAPSJUYGasUUFI1tAnvWbnKqtwqdmEiJ1lnv9j37t65bhDUVitQK1ArUCuwvwIKIcL9w/hFILmYORfsT70m7PV6R/1+/7hkck7CRzqScBT0jUbjOQzDVyRxUWIRfGXzSUATk2E4HB6C/BQjUEqdEBuNRk4qOCeASlvgyUmG6vOiKDKMAOObmKtVTUDvA/kdKo3hr0k0n88P4KRi8U457EqA3xiUXlcMf4WqW0jiEvNfMVZgMxILKXuuDb1e5LmGF4Lt620KECsg89lgMHiBvylJQvQZxWulbee8crEpoCUH0W2z2TzPsoyBnzBYulefGWCb2SoRyfPVasVzXrd7G+EmbktgvaeUe702JpKkAemHyVxXmu9KgD1nEHOPIobENIYLuW4JcKcXULIzgwsmQdMo0jH1JSg/fhMDWcJ1u91mexRfQoxPYuPxmK6y2bLWZXe73clyueT8YTabvTNip9OZ4F58gew+juOP6XSaYd8blJikafqYJAkTsrWHx51MVJBDXNsw+S5+c4/gXl7hj4U/U7NNYYmZRJEF8yKsD/1PBX4ALoh2Pv+z9QsAAAAASUVORK5CYII="
fi

if [ "$signalvalue" == 4 ]; then
    signalstrength="iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAAAkpJREFUWAntVE1LQkEUzWeKIKTSpnChTwhcuW3RxhZtgqBlq35Hv6Ntf6BtrfoB/YdCSNzUTtQXKn691znXN8Og00OfRCBemHdn7tw558ydebO3t7NdBXYV2NIKJLEvtn+xhMFq9o3w33WF0HXdC7aQJlJE5OSKOomhcPxKpXISBME7Y7Bqs9lsoO+g+WhLxolNjMQBGsFFBMiP0SduAv0jeJoSOB8Z300ECHmxWDwsl8tVYM6I6/v+VOEbfYq0WhwBJBZy+lQq9ew4zlupVDonA/r69qMCzIu0OAK4GwHGeR+AsIaz5oHXyATStTDXSiYByp2BkwuF3fsgHDMOU34+WvG7qgDJA/kddtqBvyb+cDjch5NqrFJum6YoAZwjOL36ha6w6wxEXNrA4sS4A5uRWJHqG4zzHuFmM39kWxQnZqsAYwHKfOq67iv8TQjssMwwDm3rwrT1nK0CUnIQ3abT6bPxWO7WI2C5dWFfjyI627YTVXJ/NpO3ZRINsdmsTYBGDMutx0ZHidQh5EpMeU6YfZ240IkSwDMXHGMN33cCyzpcSH0kiMkLiBg9j8s3XkWdZ2BJ1yZAJQ+SScE0H5gJYxDR5+psNsvjSYCIQ48fCPjG2AlFSgzhpYoxl6bf7flQvpJcKBQa0+mU1/6+2+1+ciafzzdA4DHW6XR67XZ7jLwPxBqDweCh3+9PPM/7yuVyPYh8abVaTyHurwLC+SWnqqAmOLbF1LzyizkqHssn6vU6f1PzmJwwZhIlLTGus/3isYTsFm13BX4AkoCpikVF9ksAAAAASUVORK5CYII="
fi

if [ "$signalvalue" == 5 ]; then
    signalstrength="iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAAAtxJREFUWAntVr+LE0EU3t38IBo0CQaiSUiyAUEsrglYWcTCRlAs7fw3LMQ/QjvvH7AUGxVL63TiwckRAoJVMKsXwu0mu37f3MwwSXZzl5i75u7B8GbfvPe+976ZnV3LupSLzkDqnAiwgZPGoI7OCVPDEDRRzpoB0XG1Wr1aLpdflUql8mg0+o5qdFFOYmn/t8DGOET+bDb7JJ1Ov8Tzbr1evwLNbRBFnEUBTDzj6HQ6Ir9t29fCMITJmuVyuQwnSngwtimCctd1HzJpr9f7Qg3w0HGOe02lUnOHcBsMEJR5OKJ2u30b+hPG50ajcRfaAngiTuICA08homP4kV/OrSiKbkExL5i3b0pbIk7iAgNPEAFeq9VutFqtO/DlvpPuqYpD43pOG4qbo5+2TQogsOrczmQyHwC012w2H4iEjqNfbeDRb6VsUoB+hbDf1wG+wy0G3TtEAuhaOddyJgDozkGJdwrdhwD0JbM+1xNEMIEiN94CUSjAXyDJb+inBJpMJup+Z+cn0h1X3CoGuMak1KJj6MfoOociHmG+FUm6iAisQDVt2OsjeaMdrYmeyE4cA7RFruvew/gKup9JMIc0Q/gYFyfdVirdjPKKY0BR/hwfkfu+7xPxHYa+bFTwJhofpbki4jpRDuFsJu6WYBOg08bEFaBjJd362ZioIg3T8RQxes2cS0e9pgJXFcA9p5/pY9OGxMKGA6kPFw6osvEm5HZhORS3IvzV7RhNp1Mds5iczxTlMMGnk8/mBRPQhiLGXMjn89wem9iw/aUN+g+LkUV60nYo67OwrWY+8ddCH1NE28VicR/OLOYNfqN+0gG/VT+CIDhE8tewecPh0Mdv1gE63cel9HY8Hgee5/0qFAoeCvk4GAzeM65SqRwgLoLfbr/f/wYT8y5tB32VKBbM5zibWld60Yf2Rdvis4pd0na32+Vrap4BR9rMJKkYG+PMV1zlUmdhCezScHEZ+Aefb98hdx9e0QAAAABJRU5ErkJggg=="
fi

echo "|templateImage=$signalstrength"
echo "---"
echo "Signal strength is at $signalvalue"
